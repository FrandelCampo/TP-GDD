USE GD2C2023;
GO

--drop fks
--...
--drop tables
IF OBJECT_ID ('BI_INMUEBLES.BI_RANGO_ETARIO', 'U') IS NOT NULL
		DROP TABLE BI_INMUEBLES.BI_RANGO_ETARIO
GO
IF OBJECT_ID('BI_INMUEBLES.BI_HECHOS_ANUNCIOS', 'U') IS NOT NULL
    DROP TABLE BI_INMUEBLES.BI_HECHOS_ANUNCIOS
GO

IF OBJECT_ID('BI_INMUEBLES.BI_TIEMPO', 'U') IS NOT NULL
    DROP TABLE BI_INMUEBLES.BI_TIEMPO
GO

IF OBJECT_ID('BI_INMUEBLES.BI_TIPO_INMUEBLE', 'U') IS NOT NULL
    DROP TABLE BI_INMUEBLES.BI_TIPO_INMUEBLE
GO

IF OBJECT_ID('BI_INMUEBLES.BI_AMBIENTES', 'U') IS NOT NULL
    DROP TABLE BI_INMUEBLES.BI_AMBIENTES
GO

IF OBJECT_ID('BI_INMUEBLES.BI_RANGO_METROS', 'U') IS NOT NULL
    DROP TABLE BI_INMUEBLES.BI_RANGO_METROS
GO

IF OBJECT_ID('BI_INMUEBLES.BI_TIPO_OPERACION', 'U') IS NOT NULL
    DROP TABLE BI_INMUEBLES.BI_TIPO_OPERACION
GO

IF OBJECT_ID('BI_INMUEBLES.BI_TIPO_MONEDA', 'U') IS NOT NULL
    DROP TABLE BI_INMUEBLES.BI_TIPO_MONEDA
GO

--Drop SPs

IF OBJECT_ID('BI_INMUEBLES.BI_MIGRAR_AMBIENTES', 'P') IS NOT NULL
    DROP PROCEDURE BI_INMUEBLES.BI_MIGRAR_AMBIENTES
GO

IF OBJECT_ID('BI_INMUEBLES.BI_MIGRAR_TIEMPO_PUBLICACION', 'P') IS NOT NULL
    DROP PROCEDURE BI_INMUEBLES.BI_MIGRAR_TIEMPO_PUBLICACION
GO

IF OBJECT_ID('BI_INMUEBLES.BI_MIGRAR_MONEDAS', 'P') IS NOT NULL
    DROP PROCEDURE BI_INMUEBLES.BI_MIGRAR_MONEDAS
GO

IF OBJECT_ID('BI_INMUEBLES.BI_MIGRAR_TIPO_OPERACION', 'P') IS NOT NULL
    DROP PROCEDURE BI_INMUEBLES.BI_MIGRAR_TIPO_OPERACION
GO

-- Drop Esquema
IF EXISTS (SELECT SCHEMA_NAME FROM INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME = 'BI_INMUEBLES')
	DROP SCHEMA BI_INMUEBLES
GO

--Creacion esquema
CREATE SCHEMA BI_INMUEBLES
GO
--Creacion DIMENSIONES 
--TODO: Verificar que los tipos de dato coincidan
--con los de la entrega anterior
--falta definir rangos etarios
CREATE TABLE BI_INMUEBLES.BI_TIEMPO(
	TIEMPO_CODIGO INT IDENTITY(1, 1) PRIMARY KEY,
	TIEMPO_ANIO INT,
	TIEMPO_CUATRIMESTRE INT,
	TIEMPO_MES INT
);
GO

CREATE TABLE BI_INMUEBLES.BI_RANGO_ETARIO(
	RANGO_ETARIO_CODIGO INT IDENTITY(1, 1) PRIMARY KEY,
	RANGO_ETARIO_DESCRIPCION nvarchar(50)
);
GO

CREATE TABLE BI_INMUEBLES.BI_TIPO_INMUEBLE(
	TIPO_INMUEBLE_CODIGO INT IDENTITY PRIMARY KEY,
	TIPO_INMUEBLE nvarchar(45)
);
GO

CREATE TABLE BI_INMUEBLES.BI_AMBIENTES(
	AMBIENTES_CODIGO INT IDENTITY(1,1) PRIMARY KEY,
	AMBIENTES_CANTIDAD nvarchar(100)
);
GO

CREATE TABLE BI_INMUEBLES.BI_RANGO_METROS(
	RANGO_METROS INT IDENTITY(1, 1) PRIMARY KEY,
	RANGO_METROS_DESCRIPCION nvarchar(50)
);
GO

CREATE TABLE BI_INMUEBLES.BI_TIPO_OPERACION(
	TIPO_OPERACION_CODIGO INT IDENTITY PRIMARY KEY,
	TIPO_OPERACION_DESCRIPCION nvarchar(100)
);
GO

CREATE TABLE BI_INMUEBLES.BI_TIPO_MONEDA(
	TIPO_MONEDA_CODIGO INT IDENTITY PRIMARY KEY,
	TIPO_MONEDA nvarchar(100)
);
GO

--rellenar tablas dimensiones
--TODO: ver si esta bien usar el mismo esquema de la entrega ant

CREATE PROCEDURE PIE_DERECHO.BI_MIGRAR_AMBIENTES
AS
BEGIN

INSERT INTO BI_INMUEBLES.BI_AMBIENTES
SELECT
	AMBIENTES_CODIGO,
	AMBIENTES_CANT_INMUEBLE
FROM PIE_DERECHO.ambientes

END
GO

--Creo que habria que hacer otra para la fecha de finalizacion
CREATE PROCEDURE BI_INMUEBLES.BI_MIGRAR_TIEMPO_PUBLICACION
AS
BEGIN
INSERT INTO BI_TIEMPO
SELECT
	YEAR(a.ANUNCIO_FECHA_PUBLICACION),
	DATEPART(Q, a.ANUNCIO_FECHA_PUBLICACION),
	DATEPART(M, a.ANUNCIO_FECHA_PUBLICACION)
FROM PIE_DERECHO.anuncios a
END
GO

CREATE PROCEDURE BI_INMUEBLES.BI_MIGRAR_MONEDAS
AS
BEGIN
INSERT INTO BI_TIPO_MONEDA
SELECT
	m.MONEDA_CODIGO,
	m.MONEDA_NOMBRE
FROM PIE_DERECHO.monedas m
END
GO


CREATE PROCEDURE BI_INMUEBLES.BI_MIGRAR_TIPO_OPERACION
AS
BEGIN
INSERT INTO BI_TIPO_OPERACION
SELECT
	t.TIPO_OPERACION_CODIGO,
	t.TIPO_OPERACION_ANUNCIO
FROM PIE_DERECHO.tipos_de_operacion t
END
GO

--tablas de hechos: ANUNCIOS y capaz [alquileres y ventas]
CREATE TABLE BI_INMUEBLES.BI_HECHOS_ANUNCIOS
(
	HECHOS_ANUNCIOS_CODIGO INT IDENTITY(1,1) PRIMARY KEY,
	TIEMPO_CODIGO INT, --FK
	TIPO_MONEDA_CODIGO INT, --FK
	RANGO_ETARIO_INQUILINO INT, --FK
	RANGO_ETARIO_EMPLEADO INT, --FK
	TIPO_INMUEBLE nvarchar(45),
	CANTIDAD_AMBIENTES INT,
	RANGO_METROS_ID INT, --FK
	TIPO_OPERACION nvarchar(100),
);
GO

--agregar constraints FK
